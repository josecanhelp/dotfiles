# ------------------------------------------------------------------------------
# Zshrc
# ------------------------------------------------------------------------------
# This file configures all of the settings for zsh.
# Alias and Functions files are sourced from external paths.
# Plugins were installed via brew.
#   -- brew install zsh-autosuggestions zsh-syntax-highlighting z.lua

zmodload zsh/zprof

# ------------------------------------------------------------------------------
# Paths
# ------------------------------------------------------------------------------

export PATH=${PATH}:/usr/local/bin
export PATH=${PATH}:/usr/local/sbin
export PATH=${PATH}:/usr/bin
export PATH=${PATH}:/usr/sbin
export PATH=${PATH}:/bin
export PATH=${PATH}:/sbin
export PATH=${PATH}:~/.composer/vendor/bin
export PATH=${PATH}:~/Library/Android/sdk
export PATH=${PATH}:~/Library/Android/sdk/platform-tools
export PATH=${PATH}:~/go/bin
export PATH=${PATH}:~/.dotfiles/bin
export PATH=${PATH}:~/.emacs.d/bin
export PATH=${PATH}:/usr/local/opt/coreutils/libexec/gnubin
export PATH=${PATH}:/usr/local/aws/bin
export PATH=${PATH}:~/.rbenv/versions/bin
export PATH=${PATH}:~/.local/bin
export PATH=${PATH}:/usr/local/opt
export PATH=${PATH}:~/.local/share/solana/install/active_release/bin
export PATH=${PATH}:/.cargo/bin


# ------------------------------------------------------------------------------
# General Settings
# ------------------------------------------------------------------------------

export EDITOR=nvim
# export VISUAL=nvim
# export PAGER=more
export ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX=YES # Required for iterm shell integration
export LANG=en_US.UTF-8
# HISTSIZE=10000
# SAVEHIST=10000
# HISTFILE=~/.cache/zsh/history
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"


# ------------------------------------------------------------------------------
# Source External ZSH Files
# ------------------------------------------------------------------------------

source $HOME/dotfiles/zsh/custom/functions.zsh
source $HOME/dotfiles/zsh/custom/aliases.zsh


# ------------------------------------------------------------------------------
# Auto-Tab / Completion
# ------------------------------------------------------------------------------

autoload -Uz compinit
zstyle ':completion:*' verbose yes
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}' # case-insensitive completion
zmodload zsh/complist
compinit
_comp_options+=(globdots)               # Include hidden files.

autoload bashcompinit && bashcompinit
complete -C '/usr/local/bin/aws_completer' aws


# ------------------------------------------------------------------------------
# Starship Prompt
# ------------------------------------------------------------------------------

eval "$(starship init zsh)"

# ------------------------------------------------------------------------------
# Vim Mode
# ------------------------------------------------------------------------------

bindkey -v '^?' backward-delete-char # Enable vim mode in zsh
export KEYTIMEOUT=1 # Remove mode switching delay.

# Use HJKL in auto-complete menu selection
bindkey -M menuselect 'h' vi-backward-char
bindkey -M menuselect 'k' vi-up-line-or-history
bindkey -M menuselect 'l' vi-forward-char
bindkey -M menuselect 'j' vi-down-line-or-history

# Edit line in Vim with CTRL-E
autoload edit-command-line; zle -N edit-command-line
bindkey '^e' edit-command-line


# ------------------------------------------------------------------------------
# Z.lua Jump to Directory
# ------------------------------------------------------------------------------

eval "$(lua /usr/local/Cellar/z.lua/1.8.13/share/z.lua/z.lua --init zsh)"

export _ZL_ROOT_MARKERS=".git,package.json,composer.json" # Jump to project root with zb


# ------------------------------------------------------------------------------
# Fzf Config
# ------------------------------------------------------------------------------

export FZF_DEFAULT_COMMAND='ag -u -g ""'
export FZF_CTRL_T_COMMAND=$FZF_DEFAULT_COMMAND
export FZF_DEFAULT_OPTS='--preview-window right:50%:noborder:hidden --color "preview-bg:234" --bind "alt-p:toggle-preview"'


# ------------------------------------------------------------------------------
# Fzf Installer Generated Config
# ------------------------------------------------------------------------------

# Setup fzf
if [[ ! "$PATH" == */usr/local/opt/fzf/bin* ]]; then
  export PATH="${PATH:+${PATH}:}/usr/local/opt/fzf/bin"
fi

# Auto-completion
[[ $- == *i* ]] && source "/usr/local/opt/fzf/shell/completion.zsh" 2> /dev/null

# GitHub CLI completion
eval "$(gh completion -s zsh)"

# Key bindings
source "/usr/local/opt/fzf/shell/key-bindings.zsh"

# ------------------------------------------------------------------------------
# Auto Suggest Settings
# ------------------------------------------------------------------------------

ZSH_AUTOSUGGEST_STRATEGY=(history completion) # First search history, then directory
ZSH_AUTOSUGGEST_USE_ASYNC=true

# Source autosuggestion plugin
source /usr/local/share/zsh-autosuggestions/zsh-autosuggestions.zsh 2>/dev/null

# ------------------------------------------------------------------------------
# Node Version Manager
# ------------------------------------------------------------------------------

# Add every binary that requires nvm, npm or node to run to an array of node globals
NODE_GLOBALS=(`find ~/.nvm/versions/node -maxdepth 3 -type l -wholename '*/bin/*' | xargs -n1 basename | sort | uniq`)
NODE_GLOBALS+=("node")
NODE_GLOBALS+=("nvm")
NODE_GLOBALS+=("npx")

# Lazy-loading nvm + npm on node globals call
load_nvm () {
  export NVM_DIR=~/.nvm
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" # This loads nvm
  if [ -f "$NVM_DIR/bash_completion" ]; then
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion" # This loads nvm bash_completion
  fi
}

# Making node global trigger the lazy loading
for cmd in "${NODE_GLOBALS[@]}"; do eval "${cmd}(){ unset -f ${cmd} >/dev/null 2>&1; load_nvm; ${cmd} \$@; }"
done

# ------------------------------------------------------------------------------
# FZF
# ------------------------------------------------------------------------------

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# ------------------------------------------------------------------------------
# Auto Suggest Settings (Needs to be last)
# ------------------------------------------------------------------------------

export ZSH_HIGHLIGHT_HIGHLIGHTERS_DIR=/usr/local/share/zsh-syntax-highlighting/highlighters

source $HOME/dotfiles/zsh/custom/artisan.plugin.zsh
#
# Source syntax highlighting plugin
source /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh 2>/dev/null
# export PATH="/usr/local/opt/php@7.4/bin:$PATH"
# export PATH="/usr/local/opt/php@7.4/sbin:$PATH"
[ -f "/Users/jose/.ghcup/env" ] && source "/Users/jose/.ghcup/env" # ghcup-env
export PATH="/usr/local/opt/node@14/bin:$PATH"
